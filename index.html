<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulateur de Retraite Avancé</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- pdf.js : on charge la lib PUIS on règle le worker dans onload -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"
    defer
    onload="window.pdfjsLib && (pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js')">
  </script>

  <style>
    body{font-family: 'Inter', sans-serif;}
    .step{display:none;}
    .step.active{display:block;}
    input[type=range]{-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;width:100%;}
    input[type=range]:focus{outline:none;}
    input[type=range]::-webkit-slider-runnable-track{background:transparent;height:.5rem;}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;margin-top:-6px;background:#4f46e5;height:1.5rem;width:1.5rem;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 2px #cbd5e1;}
    .dropzone{border:2px dashed #d1d5db;border-radius:.5rem;min-height:64px;display:flex;align-items:center;justify-content:center;text-align:center;color:#6b7280}
    .dropzone.highlight{background:#f8fafc}
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
    <!-- ÉTAPE 1 -->
    <div id="step1" class="step active">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Étape 1 : Votre Carrière Passée</h1>
        <p class="text-gray-500 mt-2">Importez votre Relevé de Situation Individuelle (RSI) ou saisissez manuellement.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div>
          <label for="initialBirthYear" class="block text-sm font-medium text-gray-600">Année de naissance</label>
          <input type="number" id="initialBirthYear" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="1980">
        </div>
        <div>
          <label for="initialChildrenCount" class="block text-sm font-medium text-gray-600">Nombre d'enfants</label>
          <input type="number" id="initialChildrenCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="2">
        </div>
        <div class="md:col-span-2 flex items-end">
          <label for="rsiFile" class="inline-flex items-center bg-green-600 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M8 12a1 1 0 102 0V5.414l1.293 1.293a1 1 0 101.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3A1 1 0 006.293 6.707L7.586 5.414V12z"/><path d="M3 13a2 2 0 012-2h10a2 2 0 012 2v3a1 1 0 11-2 0v-3H5v3a1 1 0 11-2 0v-3z"/></svg>
            Importer mon relevé (PDF)
          </label>
          <input type="file" id="rsiFile" accept="application/pdf" class="hidden">
        </div>
      </div>

      <!-- Dropzone -->
      <div id="rsi-dropzone" class="dropzone mb-4">
        Glissez-déposez votre PDF ici (ou cliquez)
      </div>

      <!-- Tableau carrière -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="career-table">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Année</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type d'Activité</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenu / Traitement (€)</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trimestres Validés</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observations</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <div class="mt-4 flex justify-between items-center">
        <button id="addRowBtn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">
          + Ajouter une année
        </button>
        <button id="proceedToStep2Btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700">
          Analyser la carrière et simuler &rarr;
        </button>
      </div>
    </div>

    <!-- ÉTAPE 2 (squelette conservé pour ne rien casser côté IDs/boutons) -->
    <div id="step2" class="step">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Étape 2 : Analyse et Simulation</h1>
        <p class="text-gray-500 mt-2">Projetez votre avenir et visualisez les optimisations possibles.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="bg-gray-50 p-6 rounded-lg space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Projection Future</h2>
            <div>
              <label for="retirementYearSlider" class="block text-sm font-medium text-gray-600 mb-2">Année de départ à la retraite</label>
              <input type="range" id="retirementYearSlider" min="2025" max="2050" value="2025">
              <div class="flex justify-between text-sm text-gray-500 mt-2">
                <span id="sliderMinLabel">2025</span>
                <span class="font-bold text-indigo-600 text-lg" id="sliderValueLabel">2025</span>
                <span id="sliderMaxLabel">2050</span>
              </div>
              <p class="text-center text-sm text-gray-600 mt-1">
                Âge de départ : <span id="retirementAgeLabel" class="font-bold">—</span>
                <span id="extraYearsLabel" class="text-green-600 font-semibold"></span>
              </p>
            </div>
          </div>

          <div class="mt-6 flex justify-between items-center">
            <button id="backToStep1Btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">
              &larr; Modifier la carrière
            </button>
            <button id="generateReportBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">
              Aperçu du Rapport
            </button>
          </div>
        </div>

        <div id="results" class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Résultats de la simulation</h2>
          <div id="results-container"></div>
          <div id="chart-wrapper" class="mt-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Répartition de la pension totale</h3>
            <div id="chart-container" class="space-y-2 text-xs"></div>
          </div>
          <div id="total-wrapper" class="mt-8 pt-6 border-t-2 border-blue-200 text-center hidden">
            <p class="text-lg text-gray-600">Montant total estimé de votre retraite :</p>
            <p class="text-4xl font-bold text-gray-900 my-2" id="pensionTotalAnnuel">€ / an</p>
            <p class="text-2xl text-gray-700" id="pensionTotalMensuel">(soit € / mois brut)</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script type="module">
    import { parseRSI } from './parser.js';

    // ÉTAT GLOBAL minimal pour conserver la navigation Step1/Step2
    let pastCareerData = { rows: [], totalTrimesters: 0, lastYear: 0 };
    let birthYear = 1980;

    // RÉFÉRENCES
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const rsiFileInput = document.getElementById('rsiFile');
    const rsiDropzone  = document.getElementById('rsi-dropzone');
    const careerTableBody = document.querySelector('#career-table tbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const proceedToStep2Btn = document.getElementById('proceedToStep2Btn');
    const backToStep1Btn = document.getElementById('backToStep1Btn');

    // UI helpers
    function addCareerRow(year = '', income = '', quarters = '') {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-2 py-2"><input type="number" class="year" placeholder="2023" value="${year}"></td>
        <td class="px-2 py-2">
          <select class="activity-type">
            <option value="private">Salarié Privé</option>
            <option value="public">Fonctionnaire</option>
            <option value="liberal">Indépendant</option>
            <option value="msa">Agriculteur</option>
          </select>
        </td>
        <td class="px-2 py-2"><input type="number" class="income" placeholder="45000" value="${income}"></td>
        <td class="px-2 py-2"><input type="number" class="quarters" placeholder="4" value="${quarters}" max="4"></td>
        <td class="px-2 py-2">
          <select class="observation">
            <option value="normal">Normale</option>
            <option value="unemployment">Chômage</option>
            <option value="sickness">Maladie</option>
            <option value="maternity">Maternité</option>
            <option value="military">Service Militaire</option>
          </select>
        </td>
        <td class="px-2 py-2"><button class="removeRowBtn bg-red-500 text-white px-2 py-1 rounded-md">X</button></td>
      `;
      careerTableBody.appendChild(row);
      row.querySelector('.removeRowBtn').addEventListener('click', () => row.remove());
    }

    // IMPORT PDF -> Remplit le tableau (unifié)
    async function handleRSIFile(file) {
      if (!file) return;
      try {
        const rights = await parseRSI(file);
        const years = (rights.years || [])
          .map(y => ({ year: Number(y.year), quarters: Number(y.quarters) || '' }))
          .sort((a,b) => a.year - b.year);

        careerTableBody.innerHTML = '';
        for (const {year, quarters} of years) {
          addCareerRow(year, '', quarters); // revenu laissé editable
        }
      } catch (e) {
        console.error('[RSI] Erreur parseRSI:', e);
        // on n’affiche pas de panneau de résumé ; l’utilisateur peut saisir à la main
      }
    }

    // Dropzone + input
    if (rsiFileInput) {
      rsiFileInput.addEventListener('change', e => handleRSIFile(e.target.files[0]));
    }
    if (rsiDropzone) {
      ['dragenter','dragover'].forEach(ev =>
        rsiDropzone.addEventListener(ev, e => { e.preventDefault(); rsiDropzone.classList.add('highlight'); })
      );
      ['dragleave','drop'].forEach(ev =>
        rsiDropzone.addEventListener(ev, e => { e.preventDefault(); rsiDropzone.classList.remove('highlight'); })
      );
      rsiDropzone.addEventListener('drop', e => handleRSIFile(e.dataTransfer.files[0]));
      rsiDropzone.addEventListener('click', () => rsiFileInput?.click());
    }

    // Ajout manuel
    addRowBtn?.addEventListener('click', () => addCareerRow());

    // Navigation Step1 -> Step2 (on garde l’ID/bouton comme avant)
    proceedToStep2Btn?.addEventListener('click', () => {
      // Reconstituer pastCareerData minimal pour Step2
      const rows = careerTableBody.querySelectorAll('tr');
      pastCareerData = { rows: [], totalTrimesters: 0, lastYear: 0 };
      rows.forEach(row => {
        const year = Number(row.querySelector('.year').value);
        const income = Number(row.querySelector('.income').value) || 0;
        const quarters = Number(row.querySelector('.quarters').value) || 0;
        const activityType = row.querySelector('.activity-type').value;
        const observation = row.querySelector('.observation').value;
        if (year) {
          pastCareerData.rows.push({ year, income, quarters, activityType, observation });
          pastCareerData.totalTrimesters += quarters;
          if (year > pastCareerData.lastYear) pastCareerData.lastYear = year;
        }
      });
      birthYear = Number(document.getElementById('initialBirthYear').value) || 1980;

      // afficher Step2
      step1.classList.remove('active');
      step2.classList.add('active');
      // (Tu conserves ton propre calcul/graphes ailleurs si besoin)
    });

    // Retour Step2 -> Step1
    backToStep1Btn?.addEventListener('click', () => {
      step2.classList.remove('active');
      step1.classList.add('active');
    });

    // Quelques lignes exemples au chargement (modifiable)
    document.addEventListener('DOMContentLoaded', () => {
      addCareerRow(2023, 46000, 4);
      addCareerRow(2022, 44000, 4);
      addCareerRow(2021, 42000, 4);
    });
  </script>
</body>
</html>
