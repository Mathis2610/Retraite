<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relevé de carrière — Import & édition</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .drop-ok { border-color:#4f46e5 !important; background:#eef2ff !important; }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 }
    input[type=number]{ -moz-appearance:textfield }
  </style>

  <!-- PDF.js (différé) -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"
    defer
    onload="window.pdfjsLib && (window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js')">
  </script>

  <!-- Modules maison -->
  <script type="module" src="./parser.js"></script>
  <script type="module" src="./mapping.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <main class="max-w-7xl mx-auto py-8 px-4">
    <header class="mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Étape 1 : Votre carrière passée</h1>
      <p class="text-gray-600 mt-1">Importez votre Relevé de carrière (PDF) <em>ou</em> saisissez manuellement. Le tableau ci‑dessous sera pré‑rempli et reste entièrement modifiable.</p>
    </header>

    <!-- Ligne paramètres courts -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <label class="block">
        <span class="text-sm text-gray-600">Année de naissance</span>
        <input id="birthYear" type="number" value="1980" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"/>
      </label>
      <label class="block">
        <span class="text-sm text-gray-600">Nombre d'enfants</span>
        <input id="childrenCount" type="number" value="2" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"/>
      </label>
      <div class="md:col-span-2 flex items-end gap-3">
        <input id="rsiFileInput" type="file" accept="application/pdf" class="hidden"/>
        <button id="importPdfBtn" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12V4m0 0l-3 3m3-3l3 3"/>
          </svg>
          Importer mon relevé (PDF)
        </button>
      </div>
    </div>

    <!-- Dropzone -->
    <div id="dropzone" class="mb-5 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center text-gray-500 cursor-pointer">
      Glissez‑déposez votre PDF ici (ou cliquez)
    </div>

    <!-- Tableau carrière (copie conforme logique + colonnes vidéo) -->
    <div class="overflow-x-auto bg-white rounded-xl shadow">
      <table id="careerTable" class="min-w-[1100px] w-full">
        <thead class="bg-gray-50 text-xs font-semibold text-gray-600">
          <tr>
            <th class="px-3 py-2 text-left">Année</th>
            <th class="px-3 py-2 text-left">Régime</th>
            <th class="px-3 py-2 text-left">Revenu annuel (€)</th>
            <th class="px-3 py-2 text-left">Trimestres</th>
            <th class="px-3 py-2 text-left">Points RCI</th>
            <th class="px-3 py-2 text-left">Points Arrco</th>
            <th class="px-3 py-2 text-left">Points Agirc TB</th>
            <th class="px-3 py-2 text-left">Points Agirc TC</th>
            <th class="px-3 py-2 text-left">Points Agirc‑Arrco</th>
            <th class="px-3 py-2 text-left">Points Ircantec</th>
            <th class="px-2 py-2"></th>
          </tr>
        </thead>
        <tbody class="text-sm" id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <button id="addRowBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-md">
        + Ajouter une année
      </button>
      <button id="analyzeBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-md">
        Analyser la carrière et simuler →
      </button>
    </div>
  </main>

  <script type="module">
    import { parseRSI } from './parser.js';
    import { employmentsToYearMap } from './mapping.js';

    // Elements
    const tbody = document.getElementById('tbody');
    const importBtn = document.getElementById('importPdfBtn');
    const fileInput = document.getElementById('rsiFileInput');
    const dropzone  = document.getElementById('dropzone');
    const addRowBtn = document.getElementById('addRowBtn');

    // Helpers UI
    function money(v){ return (v ?? '') === '' ? '' : String(Math.round(v)).replace(/\B(?=(\d{3})+(?!\d))/g, ' '); }
    function demoney(s){ if(s==null||s==='') return ''; return Number(String(s).replace(/[^\d.-]/g,'')); }

    function addRow(data={}){
      const tr = document.createElement('tr');
      tr.className = "border-b last:border-b-0";

      tr.innerHTML = `
        <td class="px-3 py-2"><input type="number" class="w-24 year border rounded px-2 py-1" value="${data.year ?? ''}"></td>
        <td class="px-3 py-2"><input type="text"   class="w-44 regime border rounded px-2 py-1" value="${data.regime ?? 'Régime général'}"></td>
        <td class="px-3 py-2"><input type="text"   class="w-36 income border rounded px-2 py-1" value="${data.income!=null?money(data.income):''}" inputmode="numeric"></td>
        <td class="px-3 py-2"><input type="number" class="w-20 quarters border rounded px-2 py-1" value="${data.quarters ?? ''}" min="0" max="4"></td>
        <td class="px-3 py-2"><input type="number" class="w-24 rci border rounded px-2 py-1" step="0.01" value="${data.points?.RCI ?? ''}"></td>
        <td class="px-3 py-2"><input type="number" class="w-24 arrco border rounded px-2 py-1" step="0.01" value="${data.points?.ARRCO ?? ''}"></td>
        <td class="px-3 py-2"><input type="number" class="w-24 agtb border rounded px-2 py-1" step="0.01" value="${data.points?.AGIRC_TB ?? ''}"></td>
        <td class="px-3 py-2"><input type="number" class="w-24 agtc border rounded px-2 py-1" step="0.01" value="${data.points?.AGIRC_TC ?? ''}"></td>
        <td class="px-3 py-2"><input type="number" class="w-28 agircArrco border rounded px-2 py-1" step="0.01" value="${data.points?.AGIRC_ARRCO ?? ''}"></td>
        <td class="px-3 py-2"><input type="number" class="w-24 ircantec border rounded px-2 py-1" step="0.01" value="${data.points?.IRCANTEC ?? ''}"></td>
        <td class="px-2 py-2 text-right">
          <button class="remove text-red-600 hover:text-red-700 px-2">✕</button>
        </td>
      `;
      tr.querySelector('.remove').addEventListener('click',()=>tr.remove());
      // format income on blur
      tr.querySelector('.income').addEventListener('blur', e => e.target.value = e.target.value ? money(demoney(e.target.value)) : '');
      tbody.appendChild(tr);
    }

    // Import actions
    importBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', e => handleFile(e.target.files?.[0]));
    dropzone.addEventListener('click', ()=> fileInput.click());
    ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.add('drop-ok'); }));
    ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.remove('drop-ok'); }));
    dropzone.addEventListener('drop', e => handleFile(e.dataTransfer.files?.[0]));

    async function handleFile(file){
      if(!file) return;
      try{
        const rights = await parseRSI(file);              // ← parser étendu
        // Agrégation revenus par année depuis employments
        const byYearIncome = employmentsToYearMap(rights.employments || {});
        // On clear et on remplit TOUT dans ce tableau
        tbody.innerHTML = '';

        // Construire l'ensemble des années vues (trimestres/points/emplois)
        const yearsSet = new Set();
        (rights.years || []).forEach(y => yearsSet.add(y.year));
        Object.keys(byYearIncome).forEach(y => yearsSet.add(+y));

        // Pour chaque année, fabriquer l’objet de ligne
        const allYears = Array.from(yearsSet).sort((a,b)=>a-b);
        for(const year of allYears){
          const yMeta   = (rights.years || []).find(r => r.year===year) || {};
          const income  = byYearIncome[year]?.income || '';
          const regime  = byYearIncome[year]?.regime || 'Régime général';

          // Points par régime (normalisés → colonnes)
          const points = mapYearPoints(rights.pointsByYear?.[year] || []);
          addRow({
            year,
            regime,
            income,
            quarters: yMeta.quarters ?? '',
            points
          });
        }
        if(allYears.length===0){
          // rien détecté ? On garde au moins 3 lignes vides
          addRow({year:new Date().getFullYear()-2});
          addRow({year:new Date().getFullYear()-1});
          addRow({year:new Date().getFullYear()});
        }
      }catch(err){
        console.error(err);
        alert("Échec de lecture du PDF.");
      }
    }

    // Normalisation des noms de régimes de points → colonnes
    function mapYearPoints(pairs){
      // pairs = [{label:'Agirc-Arrco', points:15.98}, ...]
      const out = { RCI:'', ARRCO:'', AGIRC_TB:'', AGIRC_TC:'', AGIRC_ARRCO:'', IRCANTEC:'' };
      for(const p of pairs){
        const L = (p.label||'').normalize('NFKC').toLowerCase();
        if (/\brci\b/.test(L))            out.RCI = p.points;
        else if (/ircantec/.test(L))      out.IRCANTEC = p.points;
        else if (/agirc[- ]?arrco/.test(L)) out.AGIRC_ARRCO = p.points;
        else if (/\barrco\b/.test(L))     out.ARRCO = p.points;
        else if (/agirc\s*tb/.test(L))    out.AGIRC_TB = p.points;
        else if (/agirc\s*tc/.test(L))    out.AGIRC_TC = p.points;
        // Si un libellé inattendu apparaît, on peut l’ignorer ou logger
      }
      return out;
    }

    // Ajouter une ligne manuelle
    addRowBtn.addEventListener('click', ()=> addRow({}));

    // Quelques lignes d’exemple au premier chargement (pour ne pas afficher vide)
    document.addEventListener('DOMContentLoaded', ()=>{
      addRow({year:2021, income:45000, quarters:3, points:{AGIRC_ARRCO:15.98}});
      addRow({year:2022, income:45000, quarters:4, points:{AGIRC_ARRCO:43.97}});
      addRow({year:2023, income:45000, quarters:4, points:{AGIRC_ARRCO:54.85}});
    });

    // Bouton « analyser » – (laisse ta logique existante s’intégrer plus tard)
    document.getElementById('analyzeBtn').addEventListener('click', ()=>{
      alert('OK pour la suite (simulation)…\nIci tu branches ta fonction de calcul existante.');
    });
  </script>
</body>
</html>
