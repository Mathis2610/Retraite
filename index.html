<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulateur de Retraite Avanc√©</title>

  <!-- UI / Charts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PDF.js (pour parser.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js";
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .step { display:none; } .step.active { display:block; }
    .result-card { transition:all .5s ease-in-out; opacity:0; transform:translateY(20px); max-height:0; overflow:hidden; }
    .result-card.show { opacity:1; transform:translateY(0); max-height:5000px; }
    #career-table input, #career-table select, #future-career-table input, #future-career-table select {
      width:100%; padding:.5rem; border-radius:.375rem; border:1px solid #d1d5db;
    }
    input[type=range]{-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;width:100%}
    input[type=range]:focus{outline:none}
    input[type=range]::-webkit-slider-runnable-track{background:transparent;height:.5rem}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;margin-top:-6px;background-color:#4f46e5;height:1.5rem;width:1.5rem;border-radius:50%;border:2px solid white;box-shadow:0 0 0 2px #cbd5e1}
    .slider-container{position:relative;height:1.5rem;display:flex;align-items:center;background:#e5e7eb;border-radius:.5rem}
    .slider-highlight{position:absolute;left:0;top:0;height:100%;background:#4ade80;border-radius:.5rem;z-index:1;pointer-events:none;transition:width .1s linear}
    input[type=range]{position:relative;z-index:2}
    @media print {
      body * { visibility:hidden; }
      #reportModal, #reportPrintableContent, #reportPrintableContent * { visibility:visible; }
      #reportModal { position:absolute; left:0; top:0; width:100%; }
      #closeReportBtn, #printReportBtn { display:none; }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-lg p-6 md:p-8">

    <!-- √âtape 1 -->
    <div id="step1" class="step active">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">√âtape 1 : Votre Carri√®re Pass√©e</h1>
        <p class="text-gray-500 mt-2">Importez votre Relev√© de Situation Individuelle (RSI) ou saisissez manuellement.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div>
          <label for="initialBirthYear" class="block text-sm font-medium text-gray-600">Ann√©e de naissance</label>
          <input type="number" id="initialBirthYear" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="1980">
        </div>
        <div>
          <label for="initialChildrenCount" class="block text-sm font-medium text-gray-600">Nombre d'enfants</label>
          <input type="number" id="initialChildrenCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="2">
        </div>
      </div>

      <!-- Import PDF -->
      <div class="mb-4">
        <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3">
          <label for="rsiFile"
                 class="inline-flex items-center justify-center bg-green-600 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-700">
            üìÑ Importer mon relev√© (PDF)
          </label>
          <input type="file" id="rsiFile" accept="application/pdf" class="hidden">

        <div id="rsi-dropzone"
             class="flex-1 p-3 border-2 border-dashed rounded-md text-center text-gray-500 cursor-pointer">
          Glissez-d√©posez votre PDF ici (ou cliquez)
        </div>
        </div>

        <!-- R√©sum√© import -->
        <div id="import-summary" class="mt-3 hidden">
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">R√©sum√© de l'import</h3>
            <div class="grid md:grid-cols-3 gap-2 text-sm">
              <div>üî¢ <span class="font-medium">Ann√©es d√©tect√©es :</span> <span id="sum-years">‚Äî</span></div>
              <div>üßÆ <span class="font-medium">Trimestres requis/acquis :</span> <span id="sum-quarters">‚Äî</span></div>
              <div>üü£ <span class="font-medium">Points Agirc‚ÄëArrco (total) :</span> <span id="sum-points">‚Äî</span></div>
              <div>üí∂ <span class="font-medium">Valeur du point :</span> <span id="sum-pointvalue">‚Äî</span></div>
              <div class="md:col-span-3">
                <span class="font-medium">Emplois d√©tect√©s :</span>
                <ul id="sum-employments" class="list-disc ml-6 mt-1"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tableau carri√®re -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="career-table">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ann√©e</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type d'Activit√©</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenu / Traitement (‚Ç¨)</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trimestres Valid√©s</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observations</th>
              <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <div class="mt-4 flex justify-between items-center">
        <button id="addRowBtn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">
          + Ajouter une ann√©e
        </button>
        <button id="proceedToStep2Btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700">
          Analyser la carri√®re et simuler ‚Üí
        </button>
      </div>
    </div>

    <!-- √âtape 2 -->
    <div id="step2" class="step">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">√âtape 2 : Analyse et Simulation</h1>
        <p class="text-gray-500 mt-2">Projetez votre avenir et visualisez les optimisations possibles.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="bg-gray-50 p-6 rounded-lg space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Projection Future</h2>
            <div>
              <label for="retirementYearSlider" class="block text-sm font-medium text-gray-600 mb-2">Ann√©e de d√©part √† la retraite</label>
              <div class="slider-container">
                <div class="slider-highlight"></div>
                <input type="range" id="retirementYearSlider">
              </div>
              <div class="flex justify-between text-sm text-gray-500 mt-2">
                <span id="sliderMinLabel"></span>
                <span class="font-bold text-indigo-600 text-lg" id="sliderValueLabel"></span>
                <span id="sliderMaxLabel"></span>
              </div>
              <p class="text-center text-sm text-gray-600 mt-1">
                √Çge de d√©part : <span id="retirementAgeLabel" class="font-bold"></span>
                <span id="extraYearsLabel" class="text-green-600 font-semibold"></span>
              </p>
            </div>

            <div id="future-assumptions-container" class="hidden space-y-4 pt-4 border-t border-gray-200">
              <div id="simple-future-plan">
                <h3 class="text-md font-semibold text-gray-600">Hypoth√®se Simple</h3>
                <div>
                  <label for="futureIncome" class="block text-sm font-medium text-gray-600">Revenu annuel futur</label>
                  <input type="number" id="futureIncome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="50000">
                </div>
                <div>
                  <label for="futureActivity" class="block text-sm font-medium text-gray-600">Activit√© future</label>
                  <select id="futureActivity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option value="private">Salari√© Priv√©</option>
                    <option value="public">Fonctionnaire</option>
                    <option value="liberal">Ind√©pendant</option>
                    <option value="msa">Agriculteur</option>
                  </select>
                </div>
                <button id="toggle-multi-plan-btn" class="text-sm text-indigo-600 hover:underline mt-2">
                  Passer √† une hypoth√®se pluriactivit√©
                </button>
              </div>

              <div id="multi-future-plan" class="hidden">
                <h3 class="text-md font-semibold text-gray-600">Plan de Carri√®re Future D√©taill√©</h3>
                <table id="future-career-table" class="w-full text-sm mt-2">
                  <thead class="bg-gray-200">
                  <tr>
                    <th class="px-2 py-1 text-left">Dur√©e (ans)</th>
                    <th class="px-2 py-1 text-left">Activit√©</th>
                    <th class="px-2 py-1 text-left">Revenu Annuel (‚Ç¨)</th>
                    <th class="px-2 py-1 text-left"></th>
                  </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <button id="addFutureRowBtn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg w-full mt-2">
                  + Ajouter une p√©riode
                </button>
                <div id="future-validation-message" class="text-sm text-center font-semibold mt-2"></div>
                <button id="toggle-simple-plan-btn" class="text-sm text-indigo-600 hover:underline mt-2">
                  Retour √† l'hypoth√®se simple
                </button>
              </div>
            </div>
          </div>

          <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg mt-6">
            <h2 class="text-xl font-semibold text-yellow-800 mb-2">Analyse & Optimisations</h2>
            <div id="analysis-container" class="text-sm text-gray-700 space-y-2"></div>
          </div>

          <div class="mt-6 flex justify-between items-center">
            <button id="backToStep1Btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">
              ‚Üê Modifier la carri√®re
            </button>
            <button id="generateReportBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">
              Aper√ßu du Rapport
            </button>
          </div>
        </div>

        <div id="results" class="result-card">
          <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">R√©sultats de la simulation</h2>
            <div id="results-container"></div>

            <div id="chart-wrapper" class="mt-6 hidden">
              <h3 class="text-lg font-semibold text-gray-800 mb-2">R√©partition de la pension totale</h3>
              <div id="chart-container" class="space-y-2 text-xs"></div>
            </div>

            <div id="total-wrapper" class="mt-8 pt-6 border-t-2 border-blue-200 text-center hidden">
              <p class="text-lg text-gray-600">Montant total estim√© de votre retraite :</p>
              <p class="text-4xl font-bold text-gray-900 my-2" id="pensionTotalAnnuel">‚Ç¨ / an</p>
              <p class="text-2xl text-gray-700" id="pensionTotalMensuel">(soit ‚Ç¨ / mois brut)</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal rapport -->
    <div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white">
        <div id="reportPrintableContent" class="p-4">
          <h3 class="text-2xl leading-6 font-bold text-gray-900 text-center mb-4">Rapport de Simulation Retraite</h3>

          <div class="bg-gray-100 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Hypoth√®ses de la Simulation</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
              <p><strong>Date de la simulation:</strong> <span id="reportDate"></span></p>
              <p><strong>Ann√©e de naissance:</strong> <span id="reportBirthYear"></span></p>
              <p><strong>Date de d√©part envisag√©e:</strong> <span id="reportRetirementDate"></span></p>
              <p><strong>√Çge de d√©part:</strong> <span id="reportRetirementAge"></span></p>
              <p><strong>Nombre d'enfants:</strong> <span id="reportChildren"></span></p>
              <p><strong>Plan de carri√®re futur:</strong> <span id="reportFuturePlan"></span></p>
            </div>
          </div>

          <hr class="my-6">
          <h4 class="text-lg font-semibold text-gray-800">R√©sultat Global</h4>
          <p class="text-3xl font-bold text-indigo-600 text-center my-3" id="reportTotalPension"></p>
          <div class="w-full mx-auto my-4" style="max-width: 350px;">
            <canvas id="reportChart"></canvas>
          </div>

          <div id="reportDetailsContainer" class="space-y-4"></div>

          <hr class="my-6">
          <h4 class="text-lg font-semibold text-gray-800">Analyse & Optimisations</h4>
          <div id="reportAnalysis" class="text-sm mt-2 bg-yellow-50 p-3 rounded-md"></div>
        </div>
        <div class="items-center px-4 py-3 text-center">
          <button id="closeReportBtn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
            Fermer
          </button>
          <button id="printReportBtn" onclick="window.print()" class="ml-4 px-4 py-2 bg-gray-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
            Imprimer / Sauvegarder en PDF
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- ======= App (module) ======= -->
  <script type="module">
    import { parseRSI } from './parser.js';
    import { employmentsToYearMap } from './mapping.js';

    // --- √âtat global ---
    let pastCareerData = { rows: [], totalTrimesters: 0, lastYear: 0 };
    let birthYear = 0, childrenCount = 0;
    let baselinePensions = {}, baselineRetirementYear = 0, reportChartInstance = null;

    // Constantes simplifi√©es
    const PSS = 46368;
    const AGIRC_ARRCO_POINT_VALUE = 1.4159;

    const revalorisationCoefficients = {
      2023:1, 2022:1.053, 2021:1.107, 2020:1.123, 2019:1.134, 2018:1.149, 2017:1.16, 2016:1.171, 2015:1.173,
      2014:1.175, 2013:1.18, 2012:1.201, 2011:1.229, 2010:1.254, 2009:1.272, 2008:1.288, 2007:1.314, 2006:1.339,
      2005:1.366, 2004:1.391, 2003:1.417, 2002:1.446, 2001:1.48, 1999:1.503, 1998:1.517, 1997:1.537, 1996:1.56,
      1995:1.591, 1994:1.621, 1993:1.646, 1992:1.679, 1991:1.728, 1990:1.791, 1989:1.868, 1988:1.929, 1987:1.979,
      1986:2.035, 1985:2.133, 1984:2.247, 1983:2.428, 1982:2.663, 1981:2.977, 1980:3.35, 1979:3.763, 1978:4.18, 1977:4.636, 1976:5.127
    };

    // --- DOM ---
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const careerTableBody = document.querySelector('#career-table tbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const proceedToStep2Btn = document.getElementById('proceedToStep2Btn');
    const backToStep1Btn = document.getElementById('backToStep1Btn');
    const retirementYearSlider = document.getElementById('retirementYearSlider');
    const futureAssumptionsContainer = document.getElementById('future-assumptions-container');
    const simpleFuturePlan = document.getElementById('simple-future-plan');
    const multiFuturePlan = document.getElementById('multi-future-plan');
    const addFutureRowBtn = document.getElementById('addFutureRowBtn');
    const resultsContainer = document.getElementById('results-container');
    const chartWrapper = document.getElementById('chart-wrapper');
    const totalWrapper = document.getElementById('total-wrapper');

    // Import UI
    const rsiFileInput = document.getElementById('rsiFile');
    const rsiDropzone = document.getElementById('rsi-dropzone');
    const importSummaryBox = document.getElementById('import-summary');
    const sumYears = document.getElementById('sum-years');
    const sumQuarters = document.getElementById('sum-quarters');
    const sumPoints = document.getElementById('sum-points');
    const sumPointValue = document.getElementById('sum-pointvalue');
    const sumEmployments = document.getElementById('sum-employments');

    /* ======= Lignes de carri√®re ======= */
    function addCareerRow(year = '', income = '', quarters = '') {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-2 py-2"><input type="number" class="year" placeholder="2023" value="${year}"></td>
        <td class="px-2 py-2">
          <select class="activity-type">
            <option value="private">Salari√© Priv√©</option>
            <option value="public">Fonctionnaire</option>
            <option value="liberal">Ind√©pendant</option>
            <option value="msa">Agriculteur</option>
          </select>
        </td>
        <td class="px-2 py-2"><input type="number" class="income" placeholder="45000" value="${income}"></td>
        <td class="px-2 py-2"><input type="number" class="quarters" placeholder="4" value="${quarters}" max="4"></td>
        <td class="px-2 py-2">
          <select class="observation">
            <option value="normal">Normale</option>
            <option value="unemployment">Ch√¥mage</option>
            <option value="sickness">Maladie</option>
            <option value="maternity">Maternit√©</option>
            <option value="military">Service Militaire</option>
          </select>
        </td>
        <td class="px-2 py-2"><button class="removeRowBtn bg-red-500 text-white px-2 py-1 rounded-md">X</button></td>
      `;
      careerTableBody.appendChild(row);
      row.querySelector('.removeRowBtn').addEventListener('click', () => row.remove());
      return row;
    }

    /* ======= Import RSI ======= */
    rsiFileInput.addEventListener('change', e => handleRSIFile(e.target.files[0]));
    rsiDropzone.addEventListener('click', () => rsiFileInput.click());
    ['dragenter','dragover'].forEach(ev =>
      rsiDropzone.addEventListener(ev, e => { e.preventDefault(); rsiDropzone.classList.add('bg-gray-50'); })
    );
    ['dragleave','drop'].forEach(ev =>
      rsiDropzone.addEventListener(ev, e => { e.preventDefault(); rsiDropzone.classList.remove('bg-gray-50'); })
    );
    rsiDropzone.addEventListener('drop', e => handleRSIFile(e.dataTransfer.files[0]));

    async function handleRSIFile(file) {
      if (!file) return;
      try {
        const data = await parseRSI(file);

        // R√©sum√© (max d'infos)
        importSummaryBox.classList.remove('hidden');
        sumYears.textContent = (data.years?.map(r=>r.year).sort((a,b)=>a-b).join(', ')) || '‚Äî';
        sumQuarters.textContent = `${data.requiredQuarters ?? '‚Äî'} / ${data.acquiredQuarters ?? '‚Äî'}`;
        sumPoints.textContent = data.agircArrco?.totalPoints ?? '‚Äî';
        sumPointValue.textContent = (data.agircArrco?.pointValue ?? '‚Äî') + (data.agircArrco?.pointValue ? ' ‚Ç¨' : '');
        sumEmployments.innerHTML = '';
        (data.employments || []).slice(0, 50).forEach(e => {
          const li = document.createElement('li');
          li.textContent = `${e.startDate} ‚Üí ${e.endDate} ‚Ä¢ ${e.regime || '‚Äî'} ‚Ä¢ ${e.income || '‚Äî'} ‚Ç¨`;
          sumEmployments.appendChild(li);
        });

        // Mapping revenus/activit√© par ann√©e √† partir des lignes d'emploi
        const byYear = employmentsToYearMap(data.employments || []);

        // Pr√©-remplissage du tableau
        careerTableBody.innerHTML = '';
        (data.years || [])
          .sort((a,b)=>a.year-b.year)
          .forEach(({year, quarters}) => {
            const mapped = byYear[year] || {};
            const tr = addCareerRow(year, mapped.income || '', quarters ?? '');
            if (mapped.activityType) tr.querySelector('.activity-type').value = mapped.activityType;
            tr.querySelector('.observation').value = 'normal';
          });

      } catch (err) {
        console.error(err);
        alert('Impossible de lire le fichier. V√©rifiez que le PDF est bien un relev√© support√©.');
      }
    }

    /* ======= √âtape 1 ‚Üí √âtape 2 ======= */
    addRowBtn.addEventListener('click', () => addCareerRow());

    proceedToStep2Btn.addEventListener('click', () => {
      const rows = careerTableBody.querySelectorAll('tr');
      if (rows.length === 0) { alert("Veuillez ajouter au moins une ann√©e √† votre carri√®re."); return; }

      birthYear = parseInt(document.getElementById('initialBirthYear').value);
      childrenCount = parseInt(document.getElementById('initialChildrenCount').value);
      if (!birthYear) { alert("Veuillez renseigner votre ann√©e de naissance."); return; }

      pastCareerData = { rows: [], totalTrimesters: 0, lastYear: 0 };
      rows.forEach(row => {
        const year = parseInt(row.querySelector('.year').value);
        const income = parseFloat(row.querySelector('.income').value);
        const quarters = parseInt(row.querySelector('.quarters').value);
        const activityType = row.querySelector('.activity-type').value;
        const observation = row.querySelector('.observation').value;
        if (!isNaN(year) && !isNaN(quarters)) {
          pastCareerData.totalTrimesters += (quarters || 0);
          pastCareerData.rows.push({ year, income: income || 0, quarters, activityType, observation });
          if (year > pastCareerData.lastYear) pastCareerData.lastYear = year;
        }
      });

      setupSimulationStep();
      const minRetYear = parseInt(retirementYearSlider.min);
      baselinePensions = calculateProjectedPension(minRetYear).pensions;
      baselineRetirementYear = minRetYear;

      step1.classList.remove('active');
      step2.classList.add('active');
      runSimulation();
    });

    backToStep1Btn?.addEventListener('click', () => {
      step2.classList.remove('active');
      step1.classList.add('active');
      document.getElementById('results').classList.remove('show');
    });

    /* ======= Simulation ======= */
    function setupSimulationStep() {
      const currentYear = new Date().getFullYear();
      const minYear = Math.max(currentYear, pastCareerData.lastYear + 1);
      const maxYear = (parseInt(document.getElementById('initialBirthYear').value) + 70);

      retirementYearSlider.min = minYear;
      retirementYearSlider.max = maxYear;
      retirementYearSlider.value = minYear;

      document.getElementById('sliderMinLabel').textContent = minYear;
      document.getElementById('sliderMaxLabel').textContent = maxYear;
      updateSliderLabels();
    }

    function updateSliderLabels() {
      const year = +retirementYearSlider.value;
      const minYear = +retirementYearSlider.min;
      const maxYear = +retirementYearSlider.max;
      const extraYears = year - minYear;

      document.getElementById('sliderValueLabel').textContent = year;
      const by = parseInt(document.getElementById('initialBirthYear').value) || 0;
      document.getElementById('retirementAgeLabel').textContent = `${year - by} ans`;
      const x = document.getElementById('extraYearsLabel');
      x.textContent = extraYears > 0 ? `(+${extraYears} an${extraYears>1?'s':''})` : '';

      const highlight = document.querySelector('.slider-highlight');
      const pct = (maxYear - minYear) > 0 ? (year - minYear) / (maxYear - minYear) * 100 : 0;
      highlight.style.width = `${pct}%`;
    }
    retirementYearSlider.addEventListener('input', () => { updateSliderLabels(); runSimulation(); });

    function runSimulation() {
      const retirementYear = parseInt(retirementYearSlider.value);
      const minRetYear = parseInt(retirementYearSlider.min);

      futureAssumptionsContainer.classList.toggle('hidden', !(retirementYear > minRetYear));

      const result = calculateProjectedPension(retirementYear);
      displayResults(result);
      analyzeCareer(result.finalCareer);
    }

    function calculateProjectedPension(retirementYear) {
      let rows = JSON.parse(JSON.stringify(pastCareerData.rows));
      let totalTri = pastCareerData.totalTrimesters;

      // Hypoth√®se simple (rapide)
      const futureIncome = parseFloat(document.getElementById('futureIncome')?.value || '0') || 0;
      const futureActivity = document.getElementById('futureActivity')?.value || 'private';
      const nYears = retirementYear - 1 - pastCareerData.lastYear;
      for (let i = 0; i < nYears; i++) {
        const year = pastCareerData.lastYear + 1 + i;
        totalTri += 4;
        rows.push({ year, income: futureIncome, quarters: 4, activityType: futureActivity, observation: 'normal' });
      }

      const requiredTrimesters = getRequiredTrimesters(+document.getElementById('initialBirthYear').value || 1980);
      const retirementAge = retirementYear - (+document.getElementById('initialBirthYear').value || 1980);
      let missing = (retirementAge < 67) ? Math.max(0, requiredTrimesters - totalTri) : 0;
      const decoteTri = Math.min(missing, 20);

      let pensions = {};

      // R√©gime priv√©
      const priv = rows.filter(r => r.activityType === 'private' && r.observation === 'normal');
      if (priv.length > 0) {
        const salaries = priv.map(d => ({...d, revalued: d.income * (revalorisationCoefficients[d.year] || 1)}))
                             .sort((a,b)=>b.revalued - a.revalued);
        const best25 = salaries.slice(0, 25);
        const SAM = best25.reduce((s, x)=>s + x.revalued, 0) / Math.max(1, best25.length);
        const rate = 50 - (decoteTri * 0.625);
        let base = Math.max(0, SAM * (rate/100) * (totalTri / requiredTrimesters));

        // Points compl√©mentaires (estimation simple)
        const points = priv.reduce((acc, d) => {
          const T1 = Math.min(d.income, PSS), T2 = Math.max(0, d.income - PSS);
          return acc + (((T1 * 0.062) + (T2 * 0.17)) / 18.7669);
        }, 0);

        let comp = points * AGIRC_ARRCO_POINT_VALUE;

        pensions.private = {
          base, comp,
          details: { finalSAM: SAM, rate, totalAgircArrcoPoints: points }
        };
      }

      return { pensions, retirementYear, finalCareer: rows, finalTotalTrimesters: totalTri };
    }

    function displayResults({ pensions }) {
      const chartContainer = document.getElementById('chart-container');
      const res = document.getElementById('results-container');
      res.innerHTML = '';
      chartContainer.innerHTML = '';
      let total = 0, parts = [];

      if (pensions.private) {
        const { base, comp, details } = pensions.private;
        res.innerHTML += `
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-blue-800 border-b pb-2 mb-3">R√©gime Salari√© Priv√©</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div><span class="font-medium text-gray-600">SAM projet√© :</span> <span class="block font-bold">${details.finalSAM.toFixed(0)} ‚Ç¨</span></div>
              <div><span class="font-medium text-gray-600">Taux :</span> <span class="block font-bold">${(details.rate).toFixed(2)}%</span></div>
            </div>
            <p class="text-right text-xl font-semibold mt-2">Pension Base: <span class="text-blue-600">${base.toFixed(2)} ‚Ç¨</span></p>
            <hr class="my-2">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div><span class="font-medium text-gray-600">Points Agirc‚ÄëArrco (estim.) :</span> <span class="block font-bold">${details.totalAgircArrcoPoints.toFixed(0)}</span></div>
            </div>
            <p class="text-right text-xl font-semibold mt-2">Pension Compl√©mentaire: <span class="text-blue-600">${comp.toFixed(2)} ‚Ç¨</span></p>
          </div>`;
        total += base + comp;
        parts.push({ label:'Base Priv√©', value: base, color: 'rgb(59,130,246)' });
        parts.push({ label:'Compl. Priv√©', value: comp, color: 'rgb(14,165,233)' });
      }

      document.getElementById('chart-wrapper').classList.remove('hidden');
      document.getElementById('total-wrapper').classList.remove('hidden');
      parts.forEach(p => {
        const pct = total>0 ? (p.value/total)*100 : 0;
        chartContainer.innerHTML += `
          <div class="flex items-center">
            <div class="w-24">${p.label}</div>
            <div class="flex-1 bg-gray-200 rounded-full h-4">
              <div class="h-4 rounded-full text-white text-center text-xs leading-4" style="width:${pct.toFixed(1)}%;background:${p.color}">${pct.toFixed(1)}%</div>
            </div>
          </div>`;
      });
      document.getElementById('pensionTotalAnnuel').textContent = `${total.toFixed(2)} ‚Ç¨ / an`;
      document.getElementById('pensionTotalMensuel').textContent = `(soit ${(total/12).toFixed(2)} ‚Ç¨ / mois brut)`;
      document.getElementById('results').classList.add('show');
    }

    function analyzeCareer(finalCareer){
      const box = document.getElementById('analysis-container');
      box.innerHTML = '';
      let anomalies = [], firstYear = Infinity;
      finalCareer.forEach(r => {
        if (r.year < firstYear && r.quarters > 0) firstYear = r.year;
        if (r.income > 0 && (r.quarters||0) === 0) anomalies.push(`‚ö†Ô∏è Ann√©e ${r.year}: revenu sans trimestre valid√©.`);
        if (r.income === 0 && r.observation === 'normal' && (r.quarters||0) > 0) anomalies.push(`‚ö†Ô∏è Ann√©e ${r.year}: trimestre sans revenu (p√©riode sp√©ciale ?).`);
      });
      if (anomalies.length) box.innerHTML = `<ul class="list-disc ml-5">${anomalies.map(a=>`<li>${a}</li>`).join('')}</ul>`;
      else box.textContent = '‚úÖ Aucune anomalie √©vidente d√©tect√©e.';
      const by = parseInt(document.getElementById('initialBirthYear').value)||0;
      const ageFirst = firstYear - by;
      if (ageFirst <= 20) box.innerHTML += `<p class="mt-2">üí° D√©but avant ${ageFirst+1} ans : possible √©ligibilit√© **Carri√®re Longue**.</p>`;
    }

    function getRequiredTrimesters(year){
      if (year <= 1957) return 166;
      if (year >= 1958 && year <= 1960) return 167;
      if (year === 1961) return 168;
      if (year === 1962) return 169;
      if (year === 1963) return 170;
      if (year === 1964) return 171;
      if (year >= 1965) return 172;
      return 172;
    }

    // Donn√©es d‚Äôexemple au chargement
    document.addEventListener('DOMContentLoaded', () => {
      addCareerRow(2023, 46000, 4);
      addCareerRow(2022, 44000, 4);
      addCareerRow(2021, 42000, 4);
    });

    // Rapport
    const reportModal = document.getElementById('reportModal');
    document.getElementById('generateReportBtn')?.addEventListener('click', () => {
      const retirementYear = parseInt(document.getElementById('retirementYearSlider').value);
      const birthY = parseInt(document.getElementById('initialBirthYear').value)||0;
      const retirementAge = retirementYear - birthY;

      document.getElementById('reportDate').textContent = new Date().toLocaleDateString('fr-FR');
      document.getElementById('reportBirthYear').textContent = birthY;
      document.getElementById('reportRetirementDate').textContent = `01/01/${retirementYear}`;
      document.getElementById('reportRetirementAge').textContent = `${retirementAge} ans`;
      document.getElementById('reportChildren').textContent = document.getElementById('initialChildrenCount').value;
      document.getElementById('reportFuturePlan').textContent = '‚Äî';
      document.getElementById('reportTotalPension').textContent = document.getElementById('pensionTotalAnnuel').textContent;
      document.getElementById('reportAnalysis').innerHTML = document.getElementById('analysis-container').innerHTML;
      document.getElementById('reportDetailsContainer').innerHTML = document.getElementById('results-container').innerHTML;

      const ctx = document.getElementById('reportChart').getContext('2d');
      if (reportChartInstance) reportChartInstance.destroy();
      const totalTxt = document.getElementById('pensionTotalAnnuel').textContent.replace(/[^\d.,]/g,'').replace(',','.');
      const total = parseFloat(totalTxt) || 0;
      reportChartInstance = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['Total'], datasets:[{ data:[total], backgroundColor:['#4f46e5'] }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } } }
      });
      reportModal.classList.remove('hidden');
    });
    document.getElementById('closeReportBtn')?.addEventListener('click', () => reportModal.classList.add('hidden'));
  </script>
</body>
</html>
